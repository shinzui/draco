// Generated by BUCKLESCRIPT VERSION 3.1.5, PLEASE EDIT WITH CARE
'use strict';

var Arg = require("bs-platform/lib/js/arg.js");
var $$Array = require("bs-platform/lib/js/array.js");
var Block = require("bs-platform/lib/js/block.js");
var Js_exn = require("bs-platform/lib/js/js_exn.js");
var BsAsyncMonad = require("bs-async-monad/src/bsAsyncMonad.js");
var Fs$LidcoreBsNode = require("@lidcore/bs-node/src/fs.js");
var Utils$LidcoreDraco = require("../lib/utils.js");
var Instances$LidcoreDraco = require("../lib/instances.js");

var usage = "Usage: deploy-cluster [--restart] /path/to/config.json";

var restart = [false];

var configPath = [""];

var args_000 = /* tuple */[
  "--restart",
  /* Unit */Block.__(0, [(function () {
          restart[0] = true;
          return /* () */0;
        })]),
  "Restart existing instances after deploy"
];

var args = /* :: */[
  args_000,
  /* [] */0
];

function die($staropt$star, _) {
  var msg = $staropt$star ? $staropt$star[0] : usage;
  console.log(msg);
  return process.exit(1);
}

var argc = process.argv.length;

if (argc < 3) {
  die(/* None */0, /* () */0);
}

try {
  Arg.parse_argv(/* None */0, $$Array.sub(process.argv, 2, argc - 2 | 0), args, (function (path) {
          configPath[0] = path;
          return /* () */0;
        }), usage);
}
catch (raw_exn){
  var exn = Js_exn.internalToOCamlException(raw_exn);
  if (exn[0] === Arg.Help) {
    die(/* Some */[exn[1]], /* () */0);
  } else if (exn[0] === Arg.Bad) {
    die(/* Some */[exn[1]], /* () */0);
  } else {
    throw exn;
  }
}

if (configPath[0] === "") {
  die(/* None */0, /* () */0);
}

var config = Utils$LidcoreDraco.Json[/* parse_buf */1](Fs$LidcoreBsNode.readFileSync(configPath[0]));

var restart$1 = restart[0];

var name = config.name;

console.log("Deploying " + (String(name) + "..."));

BsAsyncMonad.Callback[/* finish */27](/* None */0, BsAsyncMonad.Callback[/* >| */7](Instances$LidcoreDraco.Config[/* initialize */0](/* Some */[restart$1], config), (function () {
            console.log("Done!");
            return /* () */0;
          })));

/* argc Not a pure module */
